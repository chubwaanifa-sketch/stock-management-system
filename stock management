<!DOCTYPE html> 
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Stock Management System</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <style>
        .section{display:none}.section.active{display:block}#progressBar{transition:width .4s ease}#viewModal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:50}#viewModal.active{display:flex;align-items:center;justify-content:center}.variation-positive{color:#059669;font-weight:bold}.variation-negative{color:#dc2626;font-weight:bold}.alert-warning{background-color:#fef3c7;border:1px solid #fcd34d;padding:12px;border-radius:6px;color:#92400e}.alert-error{background-color:#fee2e2;border:1px solid #fca5a5;padding:12px;border-radius:6px;color:#991b1b}.variation-alert{background-color:#fecaca;border:2px solid #dc2626;padding:12px;border-radius:6px;color:#991b1b;font-weight:bold}
    </style>
</head>
<body class="bg-gray-100 font-sans">
<div class="flex min-h-screen">
    <aside class="w-64 bg-slate-900 text-white p-4 flex flex-col overflow-y-auto">
        <h2 class="text-xl font-bold mb-6 text-blue-400">üì¶ STOCK</h2>
        <button onclick="showSection('productSec')" class="w-full text-left px-3 py-2 rounded hover:bg-slate-700 text-sm">üì¶ Products</button>
        <button onclick="showSection('stockTakingSec')" class="w-full text-left px-3 py-2 rounded hover:bg-slate-700 text-sm">üìä Stock Taking</button>
        <button onclick="showSection('creditSec')" class="w-full text-left px-3 py-2 rounded hover:bg-slate-700 text-sm">üí≥ Credit</button>
        <button onclick="showSection('inventorySec')" class="w-full text-left px-3 py-2 rounded hover:bg-slate-700 text-sm">üè™ Inventories</button>
        <button onclick="showSection('currentStockSec')" class="w-full text-left px-3 py-2 rounded hover:bg-slate-700 text-sm">üìà Current Stock</button>
        <button onclick="showSection('inventoryMovementSec')" class="w-full text-left px-3 py-2 rounded hover:bg-slate-700 text-sm">‚ÜîÔ∏è Transfer</button>
        <button onclick="showSection('inventoryAuditSec')" class="w-full text-left px-3 py-2 rounded hover:bg-slate-700 text-sm">üîç Audit</button>
        <button onclick="showSection('reportSec')" class="w-full text-left px-3 py-2 rounded hover:bg-slate-700 text-sm">üìë Reports</button>
        <button onclick="showSection('portfolioSec')" class="w-full text-left px-3 py-2 rounded hover:bg-slate-700 text-sm">üìà Portfolio</button>
    </aside>
    <main class="flex-1 p-6 overflow-auto">
        <section id="productSec" class="section active"><div class="bg-white p-6 rounded-xl shadow-md"><div class="grid grid-cols-1 md:grid-cols-2 gap-6"><div><h3 class="font-bold text-lg mb-4">‚ûï Add Product</h3><input id="productName" type="text" placeholder="Product Name" class="w-full border p-2 rounded mb-3"><select id="productInventory" class="w-full border p-2 rounded mb-3"><option value="">Select Inventory</option></select><select id="productUnit" class="w-full border p-2 rounded mb-3"><option value="">Unit</option><option>kg</option><option>liters</option><option>pcs</option></select><button onclick="addProduct()" class="w-full bg-blue-600 text-white rounded px-4 py-2">Add</button><table class="w-full text-sm border mt-4"><thead class="bg-gray-50"><tr><th class="p-2">#</th><th class="p-2">Product</th><th class="p-2">Unit</th><th class="p-2">Inventory</th><th class="p-2">Action</th></tr></thead><tbody id="productTable"></tbody></table></div><div><h3 class="font-bold text-lg mb-4">üìä Stats</h3><div class="bg-blue-50 p-4 rounded border mb-3"><p class="text-sm">Total Products</p><p class="text-3xl font-bold" id="totalProductsCount">0</p></div><div class="bg-green-50 p-4 rounded border"><p class="text-sm">Total Inventories</p><p class="text-3xl font-bold" id="totalInventoriesCount">0</p></div></div></div></div></section>
        <section id="creditSec" class="section"><div class="bg-white p-6 rounded-xl shadow-md"><h3 class="font-bold text-lg mb-4">üí≥ Credit (Negative Variations)</h3><div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6 p-4 bg-blue-50 rounded"><select id="creditInventory" class="border p-2 rounded" onchange="renderCredit()"><option value="">All</option></select><button onclick="renderCredit()" class="bg-blue-600 text-white rounded px-4 font-bold">Refresh</button></div><table class="w-full text-sm border"><thead class="bg-red-800 text-white"><tr><th class="p-3">#</th><th class="p-3">Date</th><th class="p-3">Inventory</th><th class="p-3">Product</th><th class="p-3">Unit</th><th class="p-3">Debt</th><th class="p-3">Chef</th><th class="p-3">Cashier</th><th class="p-3">Controller</th><th class="p-3">Action</th></tr></thead><tbody id="creditTable"></tbody></table></div></section>
        <section id="currentStockSec" class="section"><div class="bg-white p-6 rounded-xl shadow-md"><h3 class="font-bold text-lg mb-4">üìà Current Stock</h3><div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6 p-4 bg-green-50 rounded"><select id="currentStockInventory" class="border p-2 rounded" onchange="renderCurrentStock()"><option value="">Select Inventory</option></select><button onclick="renderCurrentStock()" class="bg-green-600 text-white rounded px-4">Refresh</button></div><table class="w-full text-sm border"><thead class="bg-slate-800 text-white"><tr><th class="p-3">#</th><th class="p-3">Product</th><th class="p-3">Unit</th><th class="p-3">Date</th><th class="p-3">Current Stock</th></tr></thead><tbody id="currentStockTable"></tbody></table></div></section>
        <section id="inventorySec" class="section"><div class="bg-white p-6 rounded-xl shadow-md"><h3 class="font-bold text-lg mb-6">üè™ Inventory Management</h3><div class="mb-8 p-6 bg-gradient-to-r from-green-50 to-blue-50 rounded-lg border-2 border-green-200"><h4 class="font-bold text-lg mb-4">‚ûï Create Inventory</h4><div class="grid grid-cols-1 md:grid-cols-4 gap-4"><div><label class="text-sm font-bold block mb-2">Type:</label><select id="inventoryType" class="w-full border p-2 rounded" onchange="updateSubInventoryOptions()"><option value="main">Main</option><option value="sub">Sub</option></select></div><div id="mainInventoryContainer"><label class="text-sm font-bold block mb-2">Name:</label><input id="mainInventoryName" type="text" class="w-full border p-2 rounded"></div><div id="subInventoryContainer" style="display:none;"><label class="text-sm font-bold block mb-2">Linked Main:</label><select id="linkedMainInventory" class="w-full border p-2 rounded"><option value="">Select</option></select></div><div id="subNameContainer" style="display:none;"><label class="text-sm font-bold block mb-2">Sub Name:</label><input id="subInventoryName" type="text" class="w-full border p-2 rounded"></div><div class="flex items-end"><button onclick="createInventory()" class="w-full bg-green-600 text-white rounded px-4 py-2">Create</button></div></div></div><table class="w-full text-sm border"><thead class="bg-slate-800 text-white"><tr><th class="p-3">#</th><th class="p-3">Name</th><th class="p-3">Type</th><th class="p-3">Parent</th><th class="p-3">Products</th><th class="p-3">Action</th></tr></thead><tbody id="allInventoriesTable"></tbody></table></div></section>
        <section id="inventoryMovementSec" class="section"><div class="bg-white p-6 rounded-xl shadow-md"><h3 class="font-bold text-lg mb-4">‚ÜîÔ∏è Transfer Stock</h3><div id="transferMessage" class="alert-warning" style="display:none;"></div><div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6"><div class="bg-orange-50 p-4 rounded"><label class="font-bold text-sm mb-2 block">From:</label><select id="transferFromInventory" class="w-full border p-2 rounded mb-3" onchange="updateTransferProductsWithStock()"><option value="">Select</option></select><label class="font-bold text-sm mb-2 block">Product:</label><select id="transferProduct" class="w-full border p-2 rounded mb-3" onchange="displayProductCurrentStock()"><option value="">Select</option></select><div id="productStockDisplay" class="text-sm font-bold bg-blue-100 p-2 rounded mb-3">Current Stock: 0</div><label class="font-bold text-sm mb-2 block">Qty:</label><input type="number" id="transferQty" class="w-full border p-2 rounded"></div><div class="bg-blue-50 p-4 rounded"><label class="font-bold text-sm mb-2 block">To:</label><select id="transferToInventory" class="w-full border p-2 rounded mb-3"><option value="">Select</option></select><label class="font-bold text-sm mb-2 block">Notes:</label><textarea id="transferNotes" class="w-full border p-2 rounded h-20"></textarea><button onclick="transferStock()" class="w-full bg-green-600 text-white rounded px-4 py-3 mt-3">TRANSFER</button></div></div><table class="w-full text-sm border"><thead class="bg-gray-100"><tr><th class="p-2">#</th><th class="p-2">Date</th><th class="p-2">From</th><th class="p-2">To</th><th class="p-2">Product</th><th class="p-2">Qty</th><th class="p-2">Notes</th></tr></thead><tbody id="transferHistoryTable"></tbody></table></div></section>
        <section id="inventoryAuditSec" class="section"><div class="bg-white p-6 rounded-xl shadow-md"><h3 class="font-bold text-lg mb-4">üîç Audit Trail</h3><div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6 p-4 bg-blue-50 rounded"><select id="auditInventory" class="border p-2 rounded" onchange="renderAuditTrail()"><option value="">All</option></select><input type="date" id="auditFromDate" class="border p-2 rounded" onchange="renderAuditTrail()"></div><table class="w-full text-sm border"><thead class="bg-slate-800 text-white"><tr><th class="p-2">#</th><th class="p-2">Date/Time</th><th class="p-2">Type</th><th class="p-2">Inventory</th><th class="p-2">Details</th><th class="p-2">User</th></tr></thead><tbody id="auditTrailTable"></tbody></table></div></section>
        <section id="stockTakingSec" class="section"><div class="bg-white p-6 rounded-xl shadow-md"><h3 class="font-bold text-lg mb-2">üìä Stock Taking</h3><div id="warningMessage" class="alert-warning" style="display:none;"></div><div id="errorMessage" class="alert-error" style="display:none;"></div><div id="variationMessage" class="variation-alert" style="display:none;"></div><div class="grid grid-cols-1 md:grid-cols-3 gap-3 mb-4 p-3 bg-yellow-50 rounded"><input type="text" id="chef" placeholder="Chef" class="border p-2 rounded"><input type="text" id="cashier" placeholder="Cashier" class="border p-2 rounded"><input type="text" id="controller" placeholder="Controller" class="border p-2 rounded"></div><div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-4 p-3 bg-blue-50 rounded"><input type="date" id="stockDate" class="border p-2 rounded" onchange="checkDateInventoryChange()"><select id="stockInventory" class="border p-2 rounded" onchange="checkDateInventoryChange()"><option value="">Select</option></select></div><div id="currentSessionDisplay" class="mb-4 p-3 bg-green-100 rounded text-sm font-bold" style="display:none;">üìù Session: <span id="currentSessionText"></span></div><div class="mb-4 flex items-center gap-3 bg-gray-50 p-3 rounded"><label class="text-xs font-bold">Progress:</label><div class="flex-1 bg-gray-300 rounded-full h-5"><div id="progressBar" class="h-full bg-red-500 w-0"></div></div><span id="progressText" class="text-xs font-bold">0%</span></div><div id="stockInputArea" class="opacity-50 pointer-events-none grid grid-cols-8 gap-2 mb-4 bg-gray-50 p-3 rounded"><div class="col-span-2"><label class="text-xs font-bold">Product</label><select id="stockProduct" class="w-full border p-2 rounded text-xs" onchange="selectProduct()"></select></div><div><label class="text-xs">Open</label><input type="number" id="openingQty" class="w-full border p-2 rounded text-xs bg-gray-200" readonly></div><div><label class="text-xs">Add</label><input type="number" id="addedQty" value="0" class="w-full border p-2 rounded text-xs" oninput="calculate()"></div><div><label class="text-xs">Used</label><input type="number" id="usedQty" value="0" class="w-full border p-2 rounded text-xs" oninput="calculate()"></div><div><label class="text-xs">Spoil</label><input type="number" id="spoilQty" value="0" class="w-full border p-2 rounded text-xs" oninput="calculate()"></div><div><label class="text-xs font-bold">C/Stock</label><input type="number" id="cStockQty" class="w-full border p-2 rounded text-xs font-bold bg-green-50" readonly></div><div><label class="text-xs font-bold">P/Stock</label><input type="number" id="pStockQty" value="0" class="w-full border p-2 rounded text-xs font-bold" oninput="calculate()"></div><div><label class="text-xs font-bold">Var</label><input type="number" id="variationQty" class="w-full border p-2 rounded text-xs font-bold bg-orange-50" readonly></div><button onclick="addItem()" class="col-span-8 bg-blue-600 text-white h-8 rounded text-xs font-bold">ADD</button></div><table class="w-full text-xs text-center border mb-4"><thead class="bg-slate-800 text-white"><tr><th class="p-1">#</th><th class="p-1">Product</th><th class="p-1">Unit</th><th class="p-1">O</th><th class="p-1">A</th><th class="p-1">U</th><th class="p-1">S</th><th class="p-1 bg-green-700">C/S</th><th class="p-1 bg-blue-700">P/S</th><th class="p-1 bg-orange-700">V</th><th class="p-1">Action</th></tr></thead><tbody id="stockTable"></tbody></table><button onclick="saveReport()" class="bg-green-600 text-white px-6 py-2 rounded font-bold">SAVE</button> <button onclick="clearSession()" class="bg-gray-600 text-white px-6 py-2 rounded">CLEAR</button></div></section>
        <section id="reportSec" class="section"><div class="bg-white p-6 rounded-xl shadow-md"><h3 class="font-bold text-lg mb-4">üìë Reports</h3><table class="w-full text-sm border"><thead class="bg-gray-100"><tr><th class="p-3">#</th><th class="p-3">Date</th><th class="p-3">Inventory</th><th class="p-3">Chef</th><th class="p-3">Cashier</th><th class="p-3">Items</th><th class="p-3">Var Items</th><th class="p-3">Action</th></tr></thead><tbody id="historyList"></tbody></table></div></section>
        <section id="portfolioSec" class="section"><div class="bg-white p-6 rounded-xl shadow-md"><h3 class="font-bold text-lg mb-4">üìà Portfolio</h3><div class="grid grid-cols-1 md:grid-cols-5 gap-3 mb-4 p-3 bg-blue-50 rounded"><input type="date" id="portfolioFromDate" class="border p-2 rounded text-sm"><input type="date" id="portfolioToDate" class="border p-2 rounded text-sm"><select id="portfolioInventory" class="border p-2 rounded text-sm" onchange="updatePortfolioProducts()"><option value="">All</option></select><select id="portfolioProduct" class="border p-2 rounded text-sm"><option value="">All</option></select><button onclick="generatePortfolio()" class="bg-blue-600 text-white rounded px-3 font-bold text-sm col-span-1 md:col-span-5">Generate</button></div><table class="w-full text-xs border"><thead class="bg-slate-800 text-white"><tr><th class="p-1">#</th><th class="p-1">Date</th><th class="p-1">Product</th><th class="p-1">Unit</th><th class="p-1">Inv</th><th class="p-1 bg-orange-700">O</th><th class="p-1 bg-green-700">A</th><th class="p-1 bg-red-700">U</th><th class="p-1 bg-purple-700">S</th><th class="p-1 bg-blue-700">C</th><th class="p-1 bg-yellow-700">V</th></tr></thead><tbody id="portfolioTable"></tbody></table></div></section>
    </main>
</div>
<div id="viewModal"><div class="bg-white rounded-xl w-11/12 max-w-4xl p-4 relative max-h-[90vh] overflow-y-auto"><button onclick="closeModal()" class="absolute top-2 right-2 text-2xl">√ó</button><div id="modalContent"></div><div class="mt-4 flex justify-end gap-2 border-t pt-2"><button onclick="exportPDF()" class="bg-red-600 text-white px-4 py-2 rounded text-sm">PDF</button> <button onclick="closeModal()" class="bg-gray-300 px-4 py-2 rounded text-sm">Close</button></div></div></div>
<script>
let products=JSON.parse(localStorage.getItem('products'))||[],inventories=JSON.parse(localStorage.getItem('inventories'))||[],history=JSON.parse(localStorage.getItem('stockHistory'))||[],transferHistory=JSON.parse(localStorage.getItem('transferHistory'))||[],auditLog=JSON.parse(localStorage.getItem('auditLog'))||[],resolvedDebts=JSON.parse(localStorage.getItem('resolvedDebts'))||[],tableItems=[],currentReport=null,currentSession={date:null,inventory:null};
function getProductCurrentStock(t,e){const o=history.filter(o=>o.inventory===t&&o.date<new Date().toISOString().split('T')[0]).sort((t,e)=>new Date(e.date)-new Date(t.date))[0];if(!o)return 0;const r=o.items.find(o=>o.productId===e);return r?r.pStock:0}
function updateSubInventoryOptions(){const t=document.getElementById('inventoryType').value;document.getElementById('mainInventoryContainer').style.display='main'===t?'block':'none',document.getElementById('subInventoryContainer').style.display='main'===t?'none':'block',document.getElementById('subNameContainer').style.display='main'===t?'none':'block','sub'===t&&updateMainInventoryDropdown()}
function updateMainInventoryDropdown(){const t=inventories.filter(t=>'main'===t.type);document.getElementById('linkedMainInventory').innerHTML='<option value="">Select</option>'+t.map(t=>`<option value="${t.id}">${t.name}</option>`).join('')}
function updateAllInventorySelects(){document.getElementById('productInventory').innerHTML='<option value="">Select</option>'+inventories.map(t=>`<option value="${t.id}">${t.name}</option>`).join(''),document.getElementById('stockInventory').innerHTML='<option value="">Select</option>'+inventories.map(t=>`<option value="${t.id}">${t.name}</option>`).join(''),document.getElementById('portfolioInventory').innerHTML='<option value="">All</option>'+inventories.map(t=>`<option value="${t.id}">${t.name}</option>`).join(''),document.getElementById('transferFromInventory').innerHTML='<option value="">Select</option>'+inventories.map(t=>`<option value="${t.id}">${t.name}</option>`).join(''),document.getElementById('transferToInventory').innerHTML='<option value="">Select</option>'+inventories.map(t=>`<option value="${t.id}">${t.name}</option>`).join(''),document.getElementById('auditInventory').innerHTML='<option value="">All</option>'+inventories.map(t=>`<option value="${t.id}">${t.name}</option>`).join(''),document.getElementById('currentStockInventory').innerHTML='<option value="">Select</option>'+inventories.map(t=>`<option value="${t.id}">${t.name}</option>`).join(''),document.getElementById('creditInventory').innerHTML='<option value="">All</option>'+inventories.map(t=>`<option value="${t.id}">${t.name}</option>`).join(''),updateMainInventoryDropdown()}
function showSection(t){document.querySelectorAll('.section').forEach(t=>t.classList.remove('active')),document.getElementById(t).classList.add('active'),'reportSec'===t&&renderHistory(),'productSec'===t&&(refreshProductTable(),updateProductStats()),'inventorySec'===t&&renderInventorySummary(),'inventoryMovementSec'===t&&renderTransferHistory(),'inventoryAuditSec'===t&&renderAuditTrail(),'creditSec'===t&&renderCredit(),'currentStockSec'===t&&updateAllInventorySelects(),'portfolioSec'===t&&(updatePortfolioProducts(),document.getElementById('portfolioTable').innerHTML='<tr><td colspan="11" class="p-1 text-center text-gray-500">Select and Generate</td></tr>')}
function logAudit(t,e,o){auditLog.push({id:Date.now(),timestamp:new Date().toISOString(),type:t,inventory:e,details:o,user:'System'}),localStorage.setItem('auditLog',JSON.stringify(auditLog))}
function updateProductStats(){document.getElementById('totalProductsCount').textContent=products.length,document.getElementById('totalInventoriesCount').textContent=inventories.length}
function addProduct(){const t=document.getElementById('productName').value.trim(),e=document.getElementById('productInventory').value,o=document.getElementById('productUnit').value;if(!t||!e||!o)return alert('Fill all');const r=inventories.find(t=>String(t.id)===String(e));products.push({name:t,inventoryId:e,inventory:r.name,unit:o,id:String(Date.now())}),localStorage.setItem('products',JSON.stringify(products)),logAudit('CREATE_PRODUCT',r.name,`Created: ${t}`),document.getElementById('productName').value='',document.getElementById('productInventory').value='',document.getElementById('productUnit').value='',refreshProductTable(),updateProductStats(),alert('‚úÖ Added!')}
function refreshProductTable(){const t=document.getElementById('productTable');0===products.length?t.innerHTML='<tr><td colspan="5" class="p-2 text-center">No products</td></tr>':t.innerHTML=products.map((t,e)=>`<tr class="border-b"><td class="p-2">${e+1}</td><td class="p-2">${t.name}</td><td class="p-2">${t.unit}</td><td class="p-2">${t.inventory}</td><td class="p-2"><button onclick="deleteProduct('${t.id}')" class="bg-red-500 text-white px-2 py-1 rounded text-xs">Delete</button></td></tr>`).join('')}
function deleteProduct(t){confirm('Delete?')&&(products=products.filter(e=>String(e.id)!==String(t)),localStorage.setItem('products',JSON.stringify(products)),refreshProductTable(),updateProductStats(),alert('‚úÖ Deleted!'))}
function renderInventorySummary(){const t=document.getElementById('allInventoriesTable');0===inventories.length?t.innerHTML='<tr><td colspan="6" class="p-2 text-center">No inventories</td></tr>':t.innerHTML=inventories.map((t,e)=>{const o=products.filter(e=>String(e.inventoryId)===String(t.id)).length,r=t.parentId?inventories.find(e=>String(e.id)===String(t.parentId)):null,s='main'===t.type?'<span class="bg-blue-100 px-2 rounded text-xs">Main</span>':'<span class="bg-green-100 px-2 rounded text-xs">Sub</span>';return`<tr class="border-b"><td class="p-2">${e+1}</td><td class="p-2">${t.name}</td><td class="p-2">${s}</td><td class="p-2">${r?r.name:'-'}</td><td class="p-2">${o}</td><td class="p-2"><button onclick="deleteInventory('${t.id}')" class="bg-red-500 text-white px-2 py-1 rounded text-xs">Delete</button></td></tr>`}).join('')}
function renderCurrentStock(){const t=document.getElementById('currentStockInventory').value,e=document.getElementById('currentStockTable');if(!t)return e.innerHTML='<tr><td colspan="5" class="p-2 text-center">Select inventory</td></tr>',void 0;const o=inventories.find(e=>String(e.id)===String(t)),r=history.filter(t=>t.inventory===o.name).sort((t,e)=>new Date(e.date)-new Date(t.date))[0];r?e.innerHTML=r.items.map((t,e)=>`<tr class="border-b"><td class="p-2">${e+1}</td><td class="p-2">${t.name}</td><td class="p-2">${t.unit}</td><td class="p-2">${r.date}</td><td class="p-2 bg-green-100 font-bold">${t.pStock}</td></tr>`).join(''):e.innerHTML='<tr><td colspan="5" class="p-2 text-center">No history</td></tr>'}
function renderCredit(){let t=history;const e=document.getElementById('creditInventory').value;e&&(t=t.filter(t=>t.inventory===inventories.find(t=>String(t.id)===String(e))?.name));const o=document.getElementById('creditTable'),r=[];t.forEach(t=>{t.items.forEach(e=>{if(e.variation<0){const i=`${t.date}-${t.inventory}-${e.productId}`;r.push({id:i,date:t.date,inventory:t.inventory,product:e.name,unit:e.unit,debt:Math.abs(e.variation),chef:t.chef,cashier:t.cashier,controller:t.controller,resolved:resolvedDebts.some(t=>t.id===i)})}})}),0===r.length?o.innerHTML='<tr><td colspan="10" class="p-2 text-center">No debts</td></tr>':o.innerHTML=r.map((t,e)=>`<tr class="border-b ${t.resolved?'bg-green-50':''}"><td class="p-2">${e+1}</td><td class="p-2">${t.date}</td><td class="p-2">${t.inventory}</td><td class="p-2">${t.product}</td><td class="p-2">${t.unit}</td><td class="p-2 bg-red-200 font-bold">${t.debt}</td><td class="p-2">${t.chef}</td><td class="p-2">${t.cashier}</td><td class="p-2">${t.controller}</td><td class="p-2"><button onclick="acceptDebt('${t.id}')" class="bg-green-600 text-white px-3 py-1 rounded text-xs">${t.resolved?'‚úÖ Resolved':'Accept'}</button></td></tr>`).join('')}
function acceptDebt(t){resolvedDebts.some(e=>e.id===t)?(alert('Already resolved'),renderCredit()):(resolvedDebts.push({id:t,resolvedDate:new Date().toISOString()}),localStorage.setItem('resolvedDebts',JSON.stringify(resolvedDebts)),renderCredit(),alert('‚úÖ Debt resolved!'))}
function updateTransferProductsWithStock(){const t=document.getElementById('transferFromInventory').value;if(!t)return document.getElementById('transferProduct').innerHTML='<option value="">Select</option>',void 0;const e=inventories.find(e=>String(e.id)===String(t)),o=products.filter(o=>String(o.inventoryId)===String(t));document.getElementById('transferProduct').innerHTML='<option value="">Select</option>'+o.map(t=>`<option value="${t.id}">${t.name}</option>`).join('')}
function displayProductCurrentStock(){const t=document.getElementById('transferProduct').value,e=document.getElementById('transferFromInventory').value;if(!t||!e)return;const o=inventories.find(o=>String(o.id)===String(e)),r=getProductCurrentStock(o.name,t);document.getElementById('productStockDisplay').textContent=`Current Stock: ${r}`}
function transferStock(){const t=document.getElementById('transferFromInventory').value,e=document.getElementById('transferToInventory').value,o=document.getElementById('transferProduct').value,r=parseFloat(document.getElementById('transferQty').value)||0,s=document.getElementById('transferNotes').value.trim(),i=document.getElementById('transferMessage');if(i.style.display='none',!t||!e||!o||r<=0)return alert('Fill all');if(t===e)return alert('Must differ');const n=inventories.find(e=>String(e.id)===String(t)),a=inventories.find(t=>String(t.id)===String(e)),l=getProductCurrentStock(n.name,o);if(r>l)return i.style.display='block',i.textContent=`‚ö†Ô∏è Insufficient stock! Current stock is ${l}`,void 0;const c=products.find(t=>String(t.id)===String(o));transferHistory.push({id:Date.now(),date:new Date().toISOString().split('T')[0],fromInventory:n.name,toInventory:a.name,product:c.name,quantity:r,notes:s}),logAudit('TRANSFER',n.name,`Transferred ${r} of ${c.name} to ${a.name}`),alert('‚úÖ Transfer done! Stocks adjusted automatically.'),document.getElementById('transferFromInventory').value='',document.getElementById('transferToInventory').value='',document.getElementById('transferProduct').value='',document.getElementById('transferQty').value='',document.getElementById('transferNotes').value='',document.getElementById('productStockDisplay').textContent='Current Stock: 0',localStorage.setItem('transferHistory',JSON.stringify(transferHistory)),renderTransferHistory()}
function renderTransferHistory(){const t=document.getElementById('transferHistoryTable');0===transferHistory.length?t.innerHTML='<tr><td colspan="7" class="p-2 text-center">No transfers</td></tr>':t.innerHTML=transferHistory.map((t,e)=>`<tr class="border-b"><td class="p-2">${e+1}</td><td class="p-2">${t.date}</td><td class="p-2">${t.fromInventory}</td><td class="p-2">${t.toInventory}</td><td class="p-2">${t.product}</td><td class="p-2">${t.quantity}</td><td class="p-2">${t.notes||'-'}</td></tr>`).join('')}
function renderAuditTrail(){let t=auditLog;const e=document.getElementById('auditInventory').value,o=document.getElementById('auditFromDate').value;e&&(t=t.filter(t=>String(t.inventory)===String(e))),o&&(t=t.filter(t=>t.timestamp.split('T')[0]===o));const r=document.getElementById('auditTrailTable');0===t.length?r.innerHTML='<tr><td colspan="6" class="p-2 text-center">No records</td></tr>':r.innerHTML=t.slice().reverse().map((t,e)=>{const[o,s]=t.timestamp.split('T'),i=s.split('.')[0];return`<tr class="border-b"><td class="p-2">${e+1}</td><td class="p-2 text-xs">${o} ${i}</td><td class="p-2"><span class="bg-yellow-100 px-1 rounded text-xs">${t.type}</span></td><td class="p-2">${t.inventory||'-'}</td><td class="p-2 text-xs">${t.details}</td><td class="p-2">${t.user}</td></tr>`}).join('')}
function createInventory(){const t=document.getElementById('inventoryType').value;let e='',o=null;if('main'===t){if(!(e=document.getElementById('mainInventoryName').value.trim()))return alert('Fill name')}else{const r=document.getElementById('linkedMainInventory').value;if(e=document.getElementById('subInventoryName').value.trim(),!r||!e)return alert('Fill all');o=r}inventories.push({name:e,type:t,parentId:o||null,id:String(Date.now())}),localStorage.setItem('inventories',JSON.stringify(inventories)),logAudit('CREATE_INVENTORY',e,`Created ${t}`),document.getElementById('mainInventoryName').value='',document.getElementById('linkedMainInventory').value='',document.getElementById('subInventoryName').value='',document.getElementById('inventoryType').value='main',updateSubInventoryOptions(),renderInventorySummary(),updateAllInventorySelects(),alert('‚úÖ Created!')}
function deleteInventory(t){if(!confirm('Delete?'))return;const e=inventories.find(e=>String(e.id)===String(t));inventories=inventories.filter(e=>String(e.id)!==String(t)),products=products.filter(e=>String(e.inventoryId)!==String(t)),localStorage.setItem('inventories',JSON.stringify(inventories)),localStorage.setItem('products',JSON.stringify(products)),renderInventorySummary(),updateAllInventorySelects(),alert('‚úÖ Deleted!')}
function checkDateInventoryChange(){const t=document.getElementById('stockDate').value,e=document.getElementById('stockInventory').value,o=document.getElementById('warningMessage'),r=document.getElementById('errorMessage'),s=document.getElementById('variationMessage'),i=document.getElementById('stockInputArea'),n=document.getElementById('currentSessionDisplay');if(o.style.display='none',r.style.display='none',s.style.display='none',!t||!e)return i.classList.add('opacity-50','pointer-events-none'),n.style.display='none',void 0;if(history.some(o=>o.date===t&&o.inventory===inventories.find(o=>String(o.id)===String(e))?.name))return o.style.display='block',o.textContent='‚ö†Ô∏è Already counted',i.classList.add('opacity-50','pointer-events-none'),n.style.display='none',void 0;const a=inventories.find(o=>String(o.id)===String(e)),l=history.filter(t=>t.inventory===a.name).sort((t,e)=>new Date(e.date)-new Date(t.date))[0];if(l){const t=[];l.items.forEach(e=>{if(e.variation<0){const o=`${l.date}-${l.inventory}-${e.productId}`;resolvedDebts.some(t=>t.id===o)||t.push({name:e.name,variation:e.variation,date:l.date,inventory:l.inventory})}}),t.length>0&&(s.style.display='block',s.innerHTML=`‚ö†Ô∏è <strong>UNRESOLVED NEGATIVE VARIATIONS FROM ${t[0].date} (${t[0].inventory}):</strong><br>${t.map(e=>`${e.name}: ${e.variation}`).join('<br>')}<br><strong>Go to Credit section and Accept these debts!`,i.classList.add('opacity-50','pointer-events-none'),n.style.display='none',void 0)}if(tableItems.length>0&&(currentSession.date!==t||currentSession.inventory!==e))return r.style.display='block',r.innerHTML='‚ùå Clear session',document.getElementById('stockDate').value=currentSession.date,document.getElementById('stockInventory').value=currentSession.inventory,void 0;currentSession.date=t,currentSession.inventory=e,i.classList.remove('opacity-50','pointer-events-none'),n.style.display='block',document.getElementById('currentSessionText').textContent=`${a.name} - ${t}`,populateDropdown()}
function populateDropdown(){const t=document.getElementById('stockInventory').value,e=products.filter(e=>String(e.inventoryId)===String(t)),o=tableItems.map(t=>t.productId),r=e.filter(t=>!o.includes(t.id)),s=document.getElementById('stockProduct');s.innerHTML='<option value="">Select</option>'+r.map(t=>`<option value="${t.id}" data-unit="${t.unit}">${t.name}</option>`).join(''),clearInputs()}
function selectProduct(){const t=document.getElementById('stockProduct').value;if(!t)return clearInputs(),void 0;const e=document.getElementById('stockDate').value,o=document.getElementById('stockInventory').value,r=inventories.find(e=>String(e.id)===String(o));let s=0;const i=history.filter(t=>t.inventory===r.name&&t.date<e).sort((t,e)=>new Date(e.date)-new Date(t.date));if(i.length>0){const e=i[0].items.find(e=>e.productId==t);e&&(s=e.cStock,e.variation>0&&(s+=e.variation));const o=i[0].items.find(e=>e.productId==t);if(o){const t=`${i[0].date}-${i[0].inventory}-${o.productId}`;resolvedDebts.some(e=>e.id===t)&&(s-=Math.abs(o.variation))}}const n=transferHistory.filter(i=>{const n=inventories.find(t=>t.name===i.fromInventory),a=inventories.find(t=>t.name===i.toInventory),l=products.find(e=>e.name===i.product);return i.date===e&&((String(n?.id)===String(o)&&l?.id===t)||(String(a?.id)===String(o)&&l?.id===t))});let a=0;n.forEach(t=>{const e=inventories.find(e=>e.name===t.fromInventory),i=inventories.find(t=>t.name===t.toInventory);String(e?.id)===String(o)?a-=t.quantity:String(i?.id)===String(o)&&(a+=t.quantity)}),s+=a,document.getElementById('openingQty').value=s,document.getElementById('addedQty').value='0',document.getElementById('usedQty').value='0',document.getElementById('spoilQty').value='0',document.getElementById('pStockQty').value='0',calculate()}
function calculate(){const t=parseFloat(document.getElementById('openingQty').value)||0,e=parseFloat(document.getElementById('addedQty').value)||0,o=parseFloat(document.getElementById('usedQty').value)||0,r=parseFloat(document.getElementById('spoilQty').value)||0,s=parseFloat(document.getElementById('pStockQty').value)||0,i=Math.max(0,t+e-o-r),n=s-i;document.getElementById('cStockQty').value=i,document.getElementById('variationQty').value=n}
function clearInputs(){document.getElementById('openingQty').value='',document.getElementById('addedQty').value='0',document.getElementById('usedQty').value='0',document.getElementById('spoilQty').value='0',document.getElementById('pStockQty').value='0',document.getElementById('cStockQty').value='0',document.getElementById('variationQty').value='0'}
function addItem(){const t=document.getElementById('stockProduct').value;if(!t)return alert('Select'),void 0;if(tableItems.some(e=>e.productId===t))return alert('Already added'),void 0;const e=document.getElementById('stockProduct'),o=e.options[e.selectedIndex].text,r=e.options[e.selectedIndex].getAttribute('data-unit');tableItems.push({id:Date.now(),productId:t,name:o,unit:r,opening:parseFloat(document.getElementById('openingQty').value)||0,added:parseFloat(document.getElementById('addedQty').value)||0,used:parseFloat(document.getElementById('usedQty').value)||0,spoil:parseFloat(document.getElementById('spoilQty').value)||0,cStock:parseFloat(document.getElementById('cStockQty').value)||0,pStock:parseFloat(document.getElementById('pStockQty').value)||0,variation:parseFloat(document.getElementById('variationQty').value)||0}),renderTable(),clearInputs(),populateDropdown(),updateProgress()}
function renderTable(){const t=document.getElementById('stockTable');0===tableItems.length?t.innerHTML='<tr><td colspan="11" class="p-1 text-center">No items</td></tr>':t.innerHTML=tableItems.map((t,e)=>{const o=t.variation>0?'variation-positive':t.variation<0?'variation-negative':'';return`<tr class="border-b"><td class="p-1">${e+1}</td><td class="p-1">${t.name}</td><td class="p-1">${t.unit}</td><td class="p-1">${t.opening}</td><td class="p-1">${t.added}</td><td class="p-1">${t.used}</td><td class="p-1">${t.spoil}</td><td class="p-1 bg-green-100">${t.cStock}</td><td class="p-1 bg-blue-100">${t.pStock}</td><td class="p-1 bg-orange-100 ${o}">${t.variation>0?'+':''}${t.variation}</td><td class="p-1"><button onclick="removeItem('${t.productId}')" class="bg-red-500 text-white px-1 py-0 rounded text-xs">Remove</button></td></tr>`}).join('')}
function removeItem(t){tableItems=tableItems.filter(e=>e.productId!==t),renderTable(),populateDropdown(),updateProgress()}
function updateProgress(){const t=document.getElementById('stockInventory').value,e=products.filter(e=>String(e.inventoryId)===String(t)).length,o=e>0?Math.round(tableItems.length/e*100):0;document.getElementById('progressBar').style.width=o+'%',document.getElementById('progressText').textContent=o+'%'}
function clearSession(){confirm('Clear?')&&(tableItems=[],currentSession={date:null,inventory:null},document.getElementById('stockDate').value='',document.getElementById('stockInventory').value='',document.getElementById('currentSessionDisplay').style.display='none',clearInputs(),renderTable(),updateProgress(),alert('‚úÖ Cleared!'))}
function saveReport(){const t=document.getElementById('stockDate').value,e=document.getElementById('stockInventory').value,o=document.getElementById('chef').value.trim(),r=document.getElementById('cashier').value.trim(),s=document.getElementById('controller').value.trim();if(!t||!e||!o||!r||!s)return alert('Fill all');if(0===tableItems.length)return alert('Add items');if(history.some(o=>o.date===t&&o.inventory===inventories.find(o=>String(o.id)===String(e))?.name))return alert('Saved');const i=inventories.find(o=>String(o.id)===String(e));history.push({id:Date.now(),date:t,inventory:i.name,chef:o,cashier:r,controller:s,items:JSON.parse(JSON.stringify(tableItems))}),localStorage.setItem('stockHistory',JSON.stringify(history)),logAudit('SAVE_REPORT',i.name,'Saved'),alert('‚úÖ Saved!'),tableItems=[],currentSession={date:null,inventory:null},clearInputs(),renderTable(),updateProgress(),populateDropdown(),document.getElementById('stockDate').value='',document.getElementById('stockInventory').value='',document.getElementById('chef').value='',document.getElementById('cashier').value='',document.getElementById('controller').value='',document.getElementById('currentSessionDisplay').style.display='none'}
function renderHistory(){const t=document.getElementById('historyList');0===history.length?t.innerHTML='<tr><td colspan="8" class="p-2 text-center">No reports</td></tr>':t.innerHTML=history.map((t,e)=>{const o=t.items.filter(t=>0!==t.variation).length;return`<tr class="border-b"><td class="p-2">${e+1}</td><td class="p-2">${t.date}</td><td class="p-2">${t.inventory}</td><td class="p-2">${t.chef}</td><td class="p-2">${t.cashier}</td><td class="p-2">${t.items.length}</td><td class="p-2">${o}</td><td class="p-2"><button onclick="viewReport(${t.id})" class="text-blue-600 underline text-xs">View</button> | <button onclick="deleteHistory(${t.id})" class="text-red-600 underline text-xs">Delete</button></td></tr>`}).join('')}
function deleteHistory(t){confirm('Delete this report?')&&(history=history.filter(e=>e.id!==t),localStorage.setItem('stockHistory',JSON.stringify(history)),renderHistory(),closeModal(),alert('‚úÖ Deleted!'))}
function viewReport(t){currentReport=history.find(e=>e.id===t);const e=currentReport,o=e.items.map((t,e)=>{const o=t.variation>0?'text-green-600':t.variation<0?'text-red-600':'';return`<tr><td class="p-1">${e+1}</td><td class="p-1">${t.name}</td><td class="p-1">${t.unit}</td><td class="p-1">${t.opening}</td><td class="p-1">${t.added}</td><td class="p-1">${t.used}</td><td class="p-1">${t.spoil}</td><td class="p-1">${t.cStock}</td><td class="p-1">${t.pStock}</td><td class="p-1 ${o}">${t.variation}</td></tr>`}).join('');document.getElementById('modalContent').innerHTML=`<h2 class="text-xl font-bold mb-3">üìä Report</h2><table class="w-full text-xs border"><thead class="bg-slate-800 text-white"><tr><th class="p-1">#</th><th class="p-1">Product</th><th class="p-1">Unit</th><th class="p-1">O</th><th class="p-1">A</th><th class="p-1">U</th><th class="p-1">S</th><th class="p-1">C</th><th class="p-1">P</th><th class="p-1">V</th></tr></thead><tbody>${o}</tbody></table><div class="mt-8 space-y-4"><div class="flex justify-around"><div class="text-center"><p class="font-bold mb-8">Chef: ${e.chef}</p><div class="border-b-2 border-black w-40"></div></div><div class="text-center"><p class="font-bold mb-8">Cashier: ${e.cashier}</p><div class="border-b-2 border-black w-40"></div></div><div class="text-center"><p class="font-bold mb-8">Controller: ${e.controller}</p><div class="border-b-2 border-black w-40"></div></div></div></div>`,document.getElementById('viewModal').style.display='flex'}
function closeModal(){document.getElementById('viewModal').style.display='none'}
function exportPDF(){if(!currentReport)return;const{jsPDF:t}=window.jspdf,e=new t,o=currentReport,r=e.internal.pageSize.getWidth();e.setFontSize(16),e.text('STOCK REPORT',r/2,15,{align:'center'}),e.setFontSize(10),e.text(`Date: ${o.date} | Inventory: ${o.inventory}`,14,28),e.autoTable({startY:38,head:[['#','Product','Unit','O','A','U','S','C','P','V']],body:o.items.map((t,e)=>[e+1,t.name,t.unit,t.opening,t.added,t.used,t.spoil,t.cStock,t.pStock,t.variation]),theme:'grid',headStyles:{fillColor:[31,41,55],fontSize:9},bodyStyles:{fontSize:8}});const s=e.lastAutoTable.finalY+15;e.setFontSize(9);const i=35,n=(r-42)/3;e.text(`Chef: ${o.chef}`,14,s),e.line(14,s+10,14+i,s+10),e.text(`Cashier: ${o.cashier}`,14+n,s),e.line(14+n,s+10,14+n+i,s+10),e.text(`Controller: ${o.controller}`,14+2*n,s),e.line(14+2*n,s+10,14+2*n+i,s+10),e.save(`Report_${o.inventory}_${o.date}.pdf`)}
function updatePortfolioProducts(){const t=document.getElementById('portfolioInventory').value,e=t?products.filter(e=>String(e.inventoryId)===String(t)):products;document.getElementById('portfolioProduct').innerHTML='<option value="">All</option>'+e.map(t=>`<option value="${t.id}">${t.name}</option>`).join('')}
function generatePortfolio(){const t=document.getElementById('portfolioFromDate').value,e=document.getElementById('portfolioToDate').value,o=document.getElementById('portfolioInventory').value,r=document.getElementById('portfolioProduct').value;if(!t||!e)return alert('Select dates');if(t>e)return alert('Invalid');const s=history.filter(s=>{const i=s.date>=t&&s.date<=e,n=!o||s.inventory===inventories.find(t=>String(t.id)===String(o))?.name;return i&&n}).sort((t,e)=>new Date(t.date)-new Date(e.date));if(0===s.length)return alert('No data');const i=[];s.forEach(t=>{t.items.forEach(t=>{(!r||t.productId===r)&&i.push({date:t.date,name:t.name,unit:t.unit,inventory:t.inventory,opening:t.opening,added:t.added,used:t.used,spoilt:t.spoil,closing:t.cStock,variance:t.variation})})}),document.getElementById('portfolioTable').innerHTML=i.map((t,e)=>`<tr class="border-b"><td class="p-1">${e+1}</td><td class="p-1">${t.date}</td><td class="p-1">${t.name}</td><td class="p-1">${t.unit}</td><td class="p-1">${t.inventory}</td><td class="p-1 bg-orange-100">${t.opening}</td><td class="p-1 bg-green-100">${t.added}</td><td class="p-1 bg-red-100">${t.used}</td><td class="p-1 bg-purple-100">${t.spoilt}</td><td class="p-1 bg-blue-100">${t.closing}</td><td class="p-1 bg-yellow-100">${t.variance}</td></tr>`).join('')}
window.addEventListener('load',()=>{updateAllInventorySelects()});
</script>
</body>
</html>
